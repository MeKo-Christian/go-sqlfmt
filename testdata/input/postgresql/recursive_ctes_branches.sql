with recursive category_tree as(select id,name,parent_id,0 as level,array[id] as path,name as path_names from categories where parent_id is null union all select c.id,c.name,c.parent_id,ct.level+1,ct.path||c.id,ct.path_names||' > '||c.name from categories c join category_tree ct on c.parent_id=ct.id),product_hierarchy as(select p.id as product_id,p.name as product_name,p.category_id,ct.level as category_level,ct.path as category_path,ct.path_names as category_path_names from products p join category_tree ct on p.category_id=ct.id)select ph.product_id,ph.product_name,ph.category_level,ph.category_path_names,array_length(ph.category_path,1) as category_depth from product_hierarchy ph order by ph.category_path,ph.product_name;